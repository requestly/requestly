import React, { useMemo, useState, useEffect, useRef, useCallback } from "react";
import { useScopedVariables } from "features/apiClient/helpers/variableResolver/variable-resolver";
import { KeyValueTable } from "../KeyValueTable/KeyValueTable";
import { AutoGeneratedTable } from "../KeyValueTable/AutoGeneratedTable";
import { BufferedHttpRecordEntity } from "features/apiClient/slices/entities";
import { useApiClientSelector } from "features/apiClient/slices/hooks/base.hooks";
import { useAutoGeneratedFields } from "features/apiClient/slices/autoGeneratedFields/selectors";
import { useKeyValueTableSplitLayout } from "../KeyValueTable/KeyValueTableSplitLayout/KeyValueTableSplitLayout";
import { KeyValuePair } from "features/apiClient/types";

interface QueryParamsTableProps {
  entity: BufferedHttpRecordEntity;
}

export const QueryParamsTable: React.FC<QueryParamsTableProps> = React.memo(({ entity }) => {
  const queryParams = useApiClientSelector((s) => entity.getQueryParams(s));
  const scopedVariables = useScopedVariables(entity.meta.referenceId);
  const [showDescription, setShowDescription] = useState(false);
  const scrollTargetRef = useRef<HTMLDivElement>(null);

  const { queryParams: autogeneratedQueryParams } = useAutoGeneratedFields(entity);
  const headerContent = useMemo(
    () =>
      autogeneratedQueryParams.length > 0 ? (
        <AutoGeneratedTable data={autogeneratedQueryParams} type="queryParams" />
      ) : null,
    [autogeneratedQueryParams]
  );

  const layoutContext = useKeyValueTableSplitLayout();

  const prevLength = useRef(queryParams.length);
  useEffect(() => {
    if (queryParams.length !== prevLength.current) {
      scrollTargetRef.current?.scrollIntoView({ behavior: "smooth", block: "nearest" });
      prevLength.current = queryParams.length;
    }
  }, [queryParams.length]);

  const handleChange = useCallback(
    (updated: KeyValuePair[]) => {
      entity.setQueryParams(updated);
    },
    [entity]
  );

  useEffect(() => {
    if (layoutContext?.bulkEditorState?.title === "Query Params") {
      layoutContext.syncBulkEditor({
        data: queryParams,
        onChange: handleChange,
        title: "Query Params",
      });
    }
  }, [queryParams, handleChange, layoutContext]);

  const handleSetShowBulkEdit = useCallback(
    (show: boolean) => {
      if (!layoutContext) return;
      if (show) {
        layoutContext.openBulkEditor({
          data: queryParams,
          onChange: handleChange,
          title: "Query Params",
        });
      } else {
        layoutContext.closeBulkEditor();
      }
    },
    [layoutContext, queryParams, handleChange]
  );

  return (
    <>
      {headerContent}
      <KeyValueTable
        data={queryParams}
        variables={scopedVariables}
        onChange={handleChange}
        extraColumns={{
          description: {
            visible: showDescription ?? false,
            onToggle: setShowDescription,
          },
          dataType: { visible: true },
        }}
        tableType="Query Params"
        setShowBulkEditPanel={handleSetShowBulkEdit}
      />
      <div ref={scrollTargetRef} style={{ height: 1 }} />
    </>
  );
});
