import React, { PropsWithChildren, useMemo, useState } from "react";
import { useScopedVariables } from "features/apiClient/helpers/variableResolver/variable-resolver";
import { KeyValueTable } from "../KeyValueTable/KeyValueTable";
import { AutoGeneratedTable } from "../KeyValueTable/AutoGeneratedTable";
import { BufferedHttpRecordEntity } from "features/apiClient/slices/entities";
import { useApiClientSelector } from "features/apiClient/slices/hooks/base.hooks";
import { useAutoGeneratedFields } from "features/apiClient/slices/autoGeneratedFields/selectors";

interface QueryParamsTableProps {
  entity: BufferedHttpRecordEntity;
}

function Data(props: { entity: BufferedHttpRecordEntity; children: React.ReactNode; headerContent: React.ReactNode }) {
  const { entity, headerContent } = props;
  const queryParams = useApiClientSelector((s) => entity.getQueryParams(s));
  const scopedVariables = useScopedVariables(entity.meta.referenceId);
  const [showDescription, setShowDescription] = useState(false);

  return (
    <KeyValueTable
      data={queryParams}
      variables={scopedVariables}
      onChange={entity.setQueryParams.bind(entity)}
      extraColumns={{
        description: {
          visible: showDescription ?? false,
          onToggle: (show: any) => {
            setShowDescription(show);
          },
        },
        dataType: { visible: true },
      }}
      headerContent={headerContent}
      tableType="params"
    >
      {props.children}
    </KeyValueTable>
  );
}

export const QueryParamsTable: React.FC<PropsWithChildren<QueryParamsTableProps>> = React.memo(
  ({ entity, children }) => {
    const { queryParams: autogeneratedQueryParams } = useAutoGeneratedFields(entity);
    const headerContent = useMemo(
      () =>
        autogeneratedQueryParams.length > 0 ? (
          <AutoGeneratedTable data={autogeneratedQueryParams} type="queryParams" />
        ) : null,
      [autogeneratedQueryParams]
    );
    return (
      <div className="table-container">
        <div className="table-content">
          <Data entity={entity} headerContent={headerContent}>
            {children}
          </Data>
        </div>
      </div>
    );
  }
);
