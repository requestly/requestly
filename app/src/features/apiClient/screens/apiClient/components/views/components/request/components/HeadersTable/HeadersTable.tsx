import React, { useCallback, useMemo } from "react";
import { KeyValuePair } from "features/apiClient/types";
import { useAutogenerateStore } from "features/apiClient/hooks/useAutogenerateStore";
import { useScopedVariables } from "features/apiClient/helpers/variableResolver/variable-resolver";
import { KeyValueTable } from "../KeyValueTable/KeyValueTable";
import { AutoGeneratedTable } from "../KeyValueTable/AutoGeneratedTable";

interface HeadersTableProps {
  headers: KeyValuePair[];
  recordId: string;
  onHeadersChange: (headers: KeyValuePair[]) => void;
  bulkEditConfigs: {
    setIsBulkEditPanelOpen?: (isOpen: boolean) => void;
    setBulkEditTableType?: (type: "headers" | "queryParams") => void;
    showDescription?: boolean;
    onShowDescriptionChange?: (show: boolean) => void;
  };
}

function Data(props: {
  recordId: string;
  headers: KeyValuePair[];
  handleHeadersChange: (updatedPairs: KeyValuePair[]) => void;
  setIsBulkEditPanelOpen?: (isOpen: boolean) => void;
  setBulkEditTableType?: (type: "headers" | "queryParams") => void;
  showDescription?: boolean;
  onShowDescriptionChange?: (show: boolean) => void;
}) {
  const scopedVariables = useScopedVariables(props.recordId);

  return (
    <KeyValueTable
      data={props.headers}
      variables={scopedVariables}
      onChange={props.handleHeadersChange}
      config={{
        checkInvalidCharacter: true,
        bulkEdit: {
          setIsBulkEditPanelOpen: props.setIsBulkEditPanelOpen,
          setBulkEditTableType: props.setBulkEditTableType,
          bulkEditTableType: "headers",
        },
      }}
      extraColumns={{
        description: {
          visible: props.showDescription ?? false,
          onToggle: (show: any) => {
            props.onShowDescriptionChange?.(show);
          },
        },
        dataType: { visible: true },
      }}
    />
  );
}

export const HeadersTable: React.FC<HeadersTableProps> = ({
  headers,
  recordId,
  onHeadersChange,
  bulkEditConfigs: { setIsBulkEditPanelOpen, setBulkEditTableType, showDescription, onShowDescriptionChange },
}) => {
  const [headerVersion, getAllHeaders] = useAutogenerateStore((s) => [s.headerVersion, s.getAllHeaders]);

  // eslint-disable-next-line react-hooks/exhaustive-deps
  const autogeneratedHeaders = useMemo(() => getAllHeaders(), [headerVersion, getAllHeaders]);

  const handleHeadersChange = useCallback(
    (updatedHeaders: KeyValuePair[]) => {
      onHeadersChange(updatedHeaders);
    },
    [onHeadersChange]
  );

  return (
    <div>
      {autogeneratedHeaders.length > 0 && <AutoGeneratedTable data={autogeneratedHeaders} type="headers" />}
      <Data
        headers={headers}
        recordId={recordId}
        handleHeadersChange={handleHeadersChange}
        setIsBulkEditPanelOpen={setIsBulkEditPanelOpen}
        setBulkEditTableType={setBulkEditTableType}
        showDescription={showDescription}
        onShowDescriptionChange={onShowDescriptionChange}
      />
    </div>
  );
};
