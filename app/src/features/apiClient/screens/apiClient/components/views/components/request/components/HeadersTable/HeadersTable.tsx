import React, { useMemo, useState } from "react";
import { useScopedVariables } from "features/apiClient/helpers/variableResolver/variable-resolver";
import { KeyValueTable } from "../KeyValueTable/KeyValueTable";
import { AutoGeneratedTable } from "../KeyValueTable/AutoGeneratedTable";
import { BufferedGraphQLRecordEntity, BufferedHttpRecordEntity } from "features/apiClient/slices/entities";
import { useApiClientSelector } from "features/apiClient/slices/hooks/base.hooks";
import { useAutoGeneratedFields } from "features/apiClient/slices/autoGeneratedFields/selectors";
import { KeyValueFormType } from "features/apiClient/types";

function Data(props: {
  entity: BufferedHttpRecordEntity | BufferedGraphQLRecordEntity;
  headerContent: React.ReactNode;
}) {
  const { entity, headerContent } = props;
  const scopedVariables = useScopedVariables(entity.meta.referenceId);
  const [showDescription, setShowDescription] = useState(false);
  const headers = useApiClientSelector((s) => entity.getHeaders(s));
  return (
    <KeyValueTable
      data={headers}
      variables={scopedVariables}
      onChange={entity.setHeaders.bind(entity)}
      config={{ checkInvalidCharacter: true }}
      extraColumns={{
        description: {
          visible: showDescription,
          onToggle: (show: any) => {
            setShowDescription(show);
          },
        },
        dataType: { visible: true },
      }}
      headerContent={headerContent}
      tableType={KeyValueFormType.HEADERS}
    />
  );
}

interface HeadersTableProps {
  entity: BufferedHttpRecordEntity | BufferedGraphQLRecordEntity;
}

export const HeadersTable: React.FC<HeadersTableProps> = ({ entity }) => {
  const { headers: autogeneratedHeaders } = useAutoGeneratedFields(entity);
  const headerContent = useMemo(
    () => (autogeneratedHeaders.length > 0 ? <AutoGeneratedTable data={autogeneratedHeaders} type="headers" /> : null),
    [autogeneratedHeaders]
  );
  return <Data entity={entity} headerContent={headerContent} />;
};
